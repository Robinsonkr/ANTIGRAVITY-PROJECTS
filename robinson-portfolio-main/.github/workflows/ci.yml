# ============================================
# CI Pipeline â€” Lint & Build Verification
# Runs on every push and PR to main
# ============================================

name: CI â€” Lint & Build

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Python Backend Linting
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint-backend:
    name: ğŸ Lint Backend (Python)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: ğŸ“¦ Install dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8

      - name: ğŸ” Run Flake8 linting
        run: |
          cd backend
          flake8 . --config=.flake8

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Docker Build Verification
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-backend:
    name: ğŸ³ Build Backend Docker Image
    runs-on: ubuntu-latest
    needs: lint-backend

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”¨ Build Docker image
        run: |
          docker build -t robinson-backend:ci ./backend

      - name: âœ… Verify image was created
        run: |
          docker images robinson-backend:ci
          echo "âœ… Docker image built successfully!"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: Frontend Validation
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate-frontend:
    name: ğŸŒ Validate Frontend
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check HTML files exist
        run: |
          echo "Checking critical frontend files..."
          test -f index.html && echo "âœ… index.html exists" || (echo "âŒ index.html missing" && exit 1)
          test -f resume.html && echo "âœ… resume.html exists" || (echo "âŒ resume.html missing" && exit 1)
          test -f css/style.css && echo "âœ… style.css exists" || (echo "âŒ style.css missing" && exit 1)
          test -f css/chat.css && echo "âœ… chat.css exists" || (echo "âŒ chat.css missing" && exit 1)
          test -f js/main.js && echo "âœ… main.js exists" || (echo "âŒ main.js missing" && exit 1)
          test -f js/chat.js && echo "âœ… chat.js exists" || (echo "âŒ chat.js missing" && exit 1)

      - name: ğŸ”— Check for broken asset references
        run: |
          echo "Checking for broken CSS/JS references in HTML..."
          # Verify referenced files exist
          grep -oP 'href="(?!http|#|mailto)([^"]+)"' index.html | sed 's/href="//;s/"//' | while read -r file; do
            if [ -f "$file" ]; then
              echo "âœ… $file"
            else
              echo "âŒ Missing: $file"
              exit 1
            fi
          done
          echo "âœ… All local asset references valid!"
